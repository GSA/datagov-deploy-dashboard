# Cleanup after deployment

- name: Reverting /var/www/ permissions
  file:
    path: "/var/www"
    state: directory
    mode: 0755
    recurse: yes

- name: Ensuring required directories exist and have write permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: 0775
  with_items:
    - "{{ project_shared_path }}"
    - "{{ project_shared_path }}/uploads"
    - "{{ project_shared_path }}/downloads"
    - "{{ project_shared_path }}/archive"

- name: Chown www-data "{{project_source_new_code_path}}"
  file:
    path: "{{project_source_new_code_path}}"
    owner: "ubuntu"
    group: "www-data"
    recurse: yes
    follow: yes
  ignore_errors: yes

- name: Docker specific
  debug:
    msg: "Now running docker specific tasks"
  when: "'docker' == running_in"

- name: Double check php7.0-fpm status
  command: "service php7.0-fpm status"
  register: php_fpm_status
  ignore_errors: true
  when: "'docker' == running_in"

- name: Starting php7.0-fpm & nginx
  command: "service php7.0-fpm start && service nginx start"
  ignore_errors: true
  when: "'docker' == running_in and 'is not running' in php_fpm_status.stdout"

- name: Service php7.0-fpm status
  command: "service php7.0-fpm status"
  register: php_fpm_status
  when: "'docker' == running_in"
  failed_when: "'is not running' in php_fpm_status.stdout"

- name: Service nginx status
  command: "service nginx status"
  register: nginx_status
  when: "'docker' == running_in"
  failed_when: "'is not running' in nginx_status.stdout"