# Cleanup after deployment

- name: Reverting /var/www/ permissions
  file:
    path: "/var/www"
    state: directory
    mode: 0755
    recurse: yes

- name: Ensuring required directories exist and have write permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: 0775
    owner: "ubuntu"
    group: "www-data"
    recurse: yes
  with_items:
    - "{{ project_shared_path }}"
    - "{{ project_shared_path }}/uploads"
    - "{{ project_shared_path }}/downloads"
    - "{{ project_shared_path }}/archive"
    - "{{ project_shared_path }}/archive/digitalstrategy"
    - "{{ project_shared_path }}/archive/datajson"

- name: Chown www-data "{{project_source_new_code_path}}"
  file:
    path: "{{project_source_new_code_path}}"
    owner: "ubuntu"
    group: "www-data"
    recurse: yes
    follow: yes
  ignore_errors: yes

- name: Start nginx
  service: name=nginx state=started

- name: Restart nginx
  service: name=nginx state=restarted

- name: Start php7.0-fpm
  service: name=php7.0-fpm state=started

- name: Restart php7.0-fpm
  service: name=php7.0-fpm state=restarted